AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM config for Tweeter server

#
# Global Lambda function properties. These apply to every Lambda function.
#
Globals:
  Function:
    Runtime: nodejs20.x
    CodeUri: ./dist/
    Layers:
      - !Ref tweeterLayer
    Timeout: 120
    MemorySize: 128
    Environment:
      Variables:
        S3_BUCKET: tweeter-server-deploy-bucket
        FEED_UPDATE_QUEUE_URL: !Ref FeedUpdateQueue
        FEED_BATCH_QUEUE_URL: !Ref FeedBatchQueue
#
# Reusable blocks of configuration. These are referenced throughout the template to avoid duplication.
# &identifier is used to define a reusable block, and *identifier is used to reference it.
#
Metadata:
  x-common-policies: &commonPolicies
    - AWSLambdaBasicExecutionRole
    - AmazonSESFullAccess
    - CloudWatchFullAccess
    - AmazonDynamoDBFullAccess
    - AmazonS3FullAccess
    - AmazonSQSFullAccess

  x-common-cors-headers: &commonCorsHeaders
    method.response.header.Access-Control-Allow-Origin: "'*'"

  x-common-swagger-response-headers: &commonSwaggerResponseHeaders
    Access-Control-Allow-Origin:
      type: string

#
# AWS resource definitions
#
Resources:
  #
  # Web API
  #
  tweeterApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: tweeterApi
      StageName: prod
      Cors:
        AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
      DefinitionBody:
        swagger: "2.0"
        info:
          title: "Tweeter API"
          version: "1.0"
        x-common-consumes: &commonConsumes
          - application/json
        x-common-produces: &commonProduces
          - application/json
        x-common-request-templates: &commonRequestTemplates
          application/json: $input.json('$')
        x-common-amazon-responses: &commonAmazonResponses
          default:
            statusCode: 200
            responseParameters: *commonCorsHeaders
          ".*bad-request.*":
            statusCode: 400
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*unauthorized.*":
            statusCode: 401
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*internal-server-error.*":
            statusCode: 500
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
        x-common-swagger-responses: &commonSwaggerResponses
          "200":
            description: "OK"
            headers: *commonSwaggerResponseHeaders
          "400":
            description: "Bad Request"
            headers: *commonSwaggerResponseHeaders
          "401":
            description: "Unauthorized"
            headers: *commonSwaggerResponseHeaders
          "500":
            description: "Internal Server Error"
            headers: *commonSwaggerResponseHeaders
        paths:
          #
          # Endpoint definitions
          #
          /user/get:
            post:
              description: "Returns a user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userGetFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
          /user/create:
            post:
              description: "Creates a user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userCreateFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/login:
            post:
              description: "Logs in a user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userLoginFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/logout:
            post:
              description: "Logs a user out"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userLogoutFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/isfollower:
            post:
              description: "Returns if the given user is a follower of the other user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getIsFollowerStatusFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/follow:
            post:
              description: "Follows a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${followFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/unfollow:
            post:
              description: "Unfollows a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${unfollowFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /followee/count:
            post:
              description: "Returns the count of followees for a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweeCountFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follower/count:
            post:
              description: "Returns the count of followers for a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowerCountFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /followee/list:
            post:
              description: "Returns a paginated list of followees for a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweesFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follower/list:
            post:
              description: "Returns a paginated list of followers for a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowersFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /feed/list:
            post:
              description: "Returns a paginated list of feed items for a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFeedFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /story/list:
            post:
              description: "Returns a paginated list of story items for a given user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getStoryFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/post:
            post:
              description: "Posts a status for a user."
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws_proxy
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${postStatusFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              summary: "CORS preflight"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{ "statusCode": 200 }'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Headers: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'OPTIONS,POST'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
              responses:
                "200":
                  description: "CORS support"
                  headers:
                    Access-Control-Allow-Headers:
                      type: string
                    Access-Control-Allow-Methods:
                      type: string
                    Access-Control-Allow-Origin:
                      type: string
            
            #
            # ADD MORE ENDPOINT DEFINITIONS HERE
            #

  #
  # SQS Queues
  #
  
  FeedUpdateQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: FeedUpdateQueue
  
  FeedBatchQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: FeedBatchQueue

  #
  # Lambda Layer (reused by all Lambda functions)
  #
  tweeterLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: tweeterLayer
      Description: dependencies layer for Tweeter server
      ContentUri: ./layer/
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: DELETE

  #
  # Web API Lambda functions
  #
  userGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userGetFunction
      Handler: handlers/users/GetUserHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/get
            Method: POST

  userCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userCreateFunction
      Handler: handlers/users/CreateUserHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/create
            Method: POST

  userLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userLoginFunction
      Handler: handlers/users/LoginUserHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/login
            Method: POST

  userLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userLogoutFunction
      Handler: handlers/users/LogoutUserHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/logout
            Method: POST

  getIsFollowerStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getIsFollowerStatusFunction
      Handler: handlers/follow/GetIsFollowerStatusHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/isfollower
            Method: POST

  followFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: followFunction
      Handler: handlers/follow/FollowHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/follow
            Method: POST

  unfollowFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: unfollowFunction
      Handler: handlers/follow/UnfollowHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/unfollow
            Method: POST

  getFolloweeCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFolloweeCountFunction
      Handler: handlers/follow/GetFolloweeCountHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /followee/count
            Method: POST

  getFollowerCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowerCountFunction
      Handler: handlers/follow/GetFollowerCountHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follower/count
            Method: POST

  getFolloweesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFolloweesFunction
      Handler: handlers/follow/GetFolloweesHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /followee/list
            Method: POST

  getFollowersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowersFunction
      Handler: handlers/follow/GetFollowersHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follower/list
            Method: POST

  getFeedFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFeedFunction
      Handler: handlers/status/GetFeedHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /feed/list
            Method: POST

  getStoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getStoryFunction
      Handler: handlers/status/GetStoryHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /story/list
            Method: POST

  postStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: postStatusFunction
      Handler: handlers/status/PostStatusHandler.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/post
            Method: POST

  #
  # SQS Queue Lambda Functions
  #

  feedUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: feedUpdateFunction
      Handler: handlers/FeedUpdateHandler.handler
      Policies: *commonPolicies
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt FeedUpdateQueue.Arn
            Enabled: true

  feedBatchFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: feedBatchFunction
      Handler: handlers/FeedBatchHandler.handler
      Policies: *commonPolicies
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt FeedBatchQueue.Arn
            Enabled: true

  #
  # DynamoDB Tables
  #

  # TODO May need to optimize?
  authTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: auth
      AttributeDefinitions:
        - AttributeName: alias
          AttributeType: S
        - AttributeName: token
          AttributeType: S
      KeySchema:
        - AttributeName: alias
          KeyType: HASH
        - AttributeName: token
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: token_index
          KeySchema:
            - AttributeName: token
              KeyType: HASH
            - AttributeName: alias
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  userTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: users
      AttributeDefinitions:
        - AttributeName: alias
          AttributeType: S
      KeySchema:
        - AttributeName: alias
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST       

  followTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: follow
      AttributeDefinitions:
        - AttributeName: follower_handle
          AttributeType: S
        - AttributeName: followee_handle
          AttributeType: S
      KeySchema:
        - AttributeName: follower_handle
          KeyType: HASH
        - AttributeName: followee_handle
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: follow_index
          KeySchema:
            - AttributeName: followee_handle
              KeyType: HASH
            - AttributeName: follower_handle
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # story table
  storyTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: story
      AttributeDefinitions:
        - AttributeName: user_alias
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: user_alias
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  # feed table
  feedTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: feed
      AttributeDefinitions:
        - AttributeName: user_alias
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: user_alias
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
  